<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>Statistik Keuangan - FinanceApp</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">

<link rel="apple-touch-icon" href="catatan.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --white: #ffffff;
            --text-main: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg); padding-bottom: 100px; color: var(--text-main); }

        .nav-top {
            background: var(--white); padding: 18px 20px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 100;
        }
        .nav-top h1 { font-size: 16px; font-weight: 800; }

        .container { padding: 20px; }

        /* Filter Tabs */
        .filter-container {
            display: flex; background: #e2e8f0; padding: 5px;
            border-radius: 15px; margin-bottom: 20px;
        }
        .filter-btn {
            flex: 1; border: none; padding: 10px; border-radius: 12px;
            font-size: 12px; font-weight: 700; color: #64748b;
            background: transparent; cursor: pointer; transition: 0.3s;
        }
        .filter-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .chart-card {
            background: var(--white); padding: 20px; border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.03); margin-bottom: 25px;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stat-box {
            background: var(--white); padding: 15px; border-radius: 20px;
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .stat-box small { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        .stat-box p { font-size: 14px; font-weight: 800; margin-top: 5px; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--white); display: flex; justify-content: space-around;
            padding: 12px 0 20px 0; box-shadow: 0 -8px 25px rgba(0,0,0,0.05);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
        }
        .nav-item { text-decoration: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; width: 20%; }
        .nav-item i { font-size: 22px; margin-bottom: 5px; }
        .nav-item span { font-size: 9px; font-weight: 800; text-transform: uppercase; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>
    <nav class="nav-top"><h1>Statistik Laporan</h1></nav>

    <div class="container">
        <div class="filter-container">
            <button class="filter-btn active" onclick="changeFilter('all', this)">Semua</button>
            <button class="filter-btn" onclick="changeFilter('week', this)">Minggu</button>
            <button class="filter-btn" onclick="changeFilter('month', this)">Bulan</button>
            <button class="filter-btn" onclick="changeFilter('year', this)">Tahun</button>
        </div>

        <div class="chart-card">
            <canvas id="financeChart"></canvas>
        </div>

        <div class="stats-grid">
            <div class="stat-box"><small>Masuk</small><p style="color:#10b981" id="txtIn">Rp 0</p></div>
            <div class="stat-box"><small>Keluar</small><p style="color:#ef4444" id="txtOut">Rp 0</p></div>
            <div class="stat-box"><small>Pinjam</small><p style="color:#f59e0b" id="txtDebt">Rp 0</p></div>
            <div class="stat-box"><small>Piutang</small><p style="color:#8b5cf6" id="txtReceiv">Rp 0</p></div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fas fa-th-large"></i><span>Beranda</span></a>
        <a href="tambah_catatan.html" class="nav-item"><i class="fas fa-plus-circle"></i><span>Tambah</span></a>
        <a href="saldo.html" class="nav-item"><i class="fas fa-wallet"></i><span>Saldo</span></a>
        <a href="statistik.html" class="nav-item active"><i class="fas fa-chart-pie"></i><span>Laporan</span></a>
        <a href="tentang.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Info</span></a>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxo9okH0fKRF-QaEfm2jYv-CGPVnl3EJg",
            authDomain: "catatan-keuanganku-602cf.firebaseapp.com",
            projectId: "catatan-keuanganku-602cf",
            storageBucket: "catatan-keuanganku-602cf.firebasestorage.app",
            messagingSenderId: "160296493240",
            appId: "1:160296493240:web:59faa4de1b4d5d0513944d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let myChart = null;

        onAuthStateChanged(auth, (user) => {
            if (user) { loadStats('all'); } 
            else { window.location.href = "login.html"; }
        });

        window.changeFilter = (type, btn) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadStats(type);
        };

        async function loadStats(range) {
            const user = auth.currentUser;
            const q = query(collection(db, "catatan"), where("userId", "==", user.uid));
            const snap = await getDocs(q);
            
            let d = { pemasukan: 0, pengeluaran: 0, pinjaman: 0, piutang: 0 };
            const now = new Date();

            snap.forEach(doc => {
                const item = doc.data();
                const itemDate = new Date(item.tanggal);
                let valid = false;

                if (range === 'all') valid = true;
                else if (range === 'week') {
                    const weekAgo = new Date(); weekAgo.setDate(now.getDate() - 7);
                    if (itemDate >= weekAgo) valid = true;
                } else if (range === 'month') {
                    if (itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear()) valid = true;
                } else if (range === 'year') {
                    if (itemDate.getFullYear() === now.getFullYear()) valid = true;
                }

                if (valid && d.hasOwnProperty(item.tipe)) d[item.tipe] += Number(item.jumlah);
            });

            updateUI(d);
        }

        function updateUI(d) {
            document.getElementById('txtIn').innerText = 'Rp ' + d.pemasukan.toLocaleString('id-ID');
            document.getElementById('txtOut').innerText = 'Rp ' + d.pengeluaran.toLocaleString('id-ID');
            document.getElementById('txtDebt').innerText = 'Rp ' + d.pinjaman.toLocaleString('id-ID');
            document.getElementById('txtReceiv').innerText = 'Rp ' + d.piutang.toLocaleString('id-ID');

            const ctx = document.getElementById('financeChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Masuk', 'Keluar', 'Pinjam', 'Piutang'],
                    datasets: [{
                        data: [d.pemasukan, d.pengeluaran, d.pinjaman, d.piutang],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } }, cutout: '70%' }
            });
        }
    </script>
</body>
</html>
